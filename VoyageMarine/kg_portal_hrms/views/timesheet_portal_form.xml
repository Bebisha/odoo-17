<?xml version="1.0" encoding="UTF-8" ?>
<odoo>

    <template id="portal_timesheet_form">
        <t t-call="website.layout">
            <style>
                .timesheet-form {
                max-width: 800px;
                margin: 0 auto;
                padding: 20px;
                background: #f9f9f9;
                border-radius: 8px;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
                display: flex;
                flex-wrap: wrap;
                justify-content: space-between;
                }
                .form-group {
                flex: 1 1 45%; /* Adjusts to 2 columns */
                margin: 10px;
                }
                .description-group {
                flex: 1 1 45%; /* Adjusts to 2 columns */
                margin: 10px;
                }
                .timesheet-form h1 {
                width: 100%;
                text-align: center;
                color: #333;
                margin-bottom: 20px;
                }
                .timesheet-form label {
                font-weight: bold;
                display: block;
                }
                .timesheet-form input,
                .timesheet-form select,
                .timesheet-form textarea {
                width: 100%;
                padding: 10px;
                margin-top: 5px;
                border: 1px solid #ccc;
                border-radius: 4px;
                font-size: 16px;
                }
                .submit-button {
                display: flex;
                justify-content: center; /* Horizontal center */
                align-items: center;
                width: 100%; /* Full width for the submit button */
                margin-top: 20px; /* Add some space above the button */
                }
                .submit-button button {
                background-color: #5cb85c;
                color: white;
                padding: 10px;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-size: 16px;
                transition: background-color 0.3s;
                width: 40%; /* Full width */
                }
                .submit-button button:hover {
                background-color: #4cae4c;
                }
            </style>

            <div class="container">
                <form id="registration_form" action="/employee/timesheet_form/submit" method="post">
                    <div class="timesheet-form">
                        <h1>Timesheet</h1>
                        <input type="hidden" id="employee_id" name="employee_id" t-att-value="employee_id"/>

                        <div class="form-group">
                            <label for="Employee">Employee:</label>
                            <select id="employee_select" name="employees_id" required="1">
                                <option value="">Select Employee</option>
                                <t t-foreach="employees" t-as="employ">
                                    <option t-att-value="employ.id">
                                        <t t-esc="employ.name"/>
                                    </option>
                                </t>
                            </select>
                        </div>


                        <script>
                            document.addEventListener('DOMContentLoaded', function () {
                            var employeeSelect = document.getElementById('employee_select');
                            var taskSelect = document.getElementById('task_select');
                            var projectSelect = document.getElementById('project_select');

                            employeeSelect.value = ''; // Set the value to an empty string

                            // Fetch all tasks and projects when the page loads
                            fetch('/employee/get_projects', {
                            method: 'POST',
                            headers: {
                            'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ employeeId: null }) // No employee selected
                            })
                            .then(response => response.json())
                            .then(data => {
                            populateDropdowns(data);
                            });

                            // Fetch tasks and projects for the selected employee
                            employeeSelect.addEventListener('change', function () {
                            var employeeId = this.value;
                            console.log('Selected Employee ID:', employeeId);
                            fetch('/employee/get_projects', {
                            method: 'POST',
                            headers: {
                            'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                            employeeId: employeeId ? parseInt(employeeId) : null
                            })
                            })
                            .then(response => response.json())
                            .then(data => {
                            populateDropdowns(data);
                            });
                            });

                            // Filter the project dropdown based on the selected task
                            taskSelect.addEventListener('change', function () {
                            var selectedTask = this.options[this.selectedIndex];
                            var associatedProjectId = selectedTask ? selectedTask.dataset.projectId : null;

                            // Show only the associated project
                            Array.from(projectSelect.options).forEach(function (option) {
                            option.style.display = !associatedProjectId || option.value === associatedProjectId ?
                            'block' : 'none';
                            });

                            // Automatically select the associated project
                            projectSelect.value = associatedProjectId || '';
                            });

                            function populateDropdowns(data) {
                            // Clear existing options
                            taskSelect.innerHTML = '<option value="">Select a task</option>';
                            projectSelect.innerHTML = '<option value="">Select a project</option>';

                            // Populate tasks
                            data.result.tasks.forEach(function (task) {
                            var opt = document.createElement('option');
                            opt.textContent = task.name;
                            opt.value = task.id;
                            opt.dataset.projectId = task.project_id; // Store project_id in a data attribute
                            taskSelect.appendChild(opt);
                            });

                            // Populate projects
                            data.result.projects.forEach(function (project) {
                            var opt = document.createElement('option');
                            opt.textContent = project.name;
                            opt.value = project.id;
                            projectSelect.appendChild(opt);
                            });
                            }
                            });
                        </script>


                        <div class="form-group">
                            <label for="task_select">Task:</label>
                            <select id="task_select" name="task_id" required="1">
                                <option value="">Select a task</option>
                                <t t-foreach="tasks" t-as="task">
                                    <option t-att-value="task.id" t-att-data-project-id="task.project_id.id">
                                        <t t-esc="task.name"/>
                                    </option>
                                </t>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="project_select">Project:</label>
                            <select id="project_select" name="project_id" required="1">
                                <option value="">Select a project</option>
                                <t t-foreach="projects" t-as="project">
                                    <option t-att-value="project.id">
                                        <t t-esc="project.name"/>
                                    </option>
                                </t>
                            </select>
                        </div>

                        <div class="form-group">
                            <label>Date:</label>
                            <input type="date" name="date" required="1"/>
                        </div>
                        <div class="form-group">
                            <label>Spent Hours:</label>
                            <input type="text" name="hours" required="1" placeholder="HH:MM" id="spent_hours"
                                   maxlength="5"/>
                            <small>Format: HH:MM (e.g., 22:45)</small>
                        </div>
                        <script>
                            document.getElementById('spent_hours').addEventListener('input', function (e) {
                            // Only allow numbers and one colon
                            let value = e.target.value.replace(/[^0-9:]/g, '');

                            // Auto-insert colon if two digits are entered for hours
                            if (value.length === 2 &amp;&amp; !value.includes(':')) {
                            value = value + ':';
                            }

                            // Restrict to HH:MM format (max 5 characters)
                            e.target.value = value.slice(0, 5);
                            });

                            document.getElementById('spent_hours').addEventListener('blur', function (e) {
                            const regex = /^([01]?[0-9]|2[0-3]):[0-5][0-9]$/; // HH:MM validation
                            if (!regex.test(e.target.value)) {
                            alert('Invalid format. Please enter time as HH:MM (e.g., 22:45).');
                            e.target.focus();
                            }
                            });
                        </script>


                        <!--                        <script>-->
                        <!--                            document.getElementById('project_select').addEventListener('change', function() {-->
                        <!--                            var selectedProjectId = this.value;-->
                        <!--                            var taskSelect = document.getElementById('task_select');-->

                        <!--                            // Loop through all tasks and show only those matching the selected project-->
                        <!--                            for (var i = 0; i&lt; taskSelect.options.length; i++) {-->
                        <!--                            var taskOption = taskSelect.options[i];-->
                        <!--                            var taskProjectId = taskOption.getAttribute('data-project-id');-->

                        <!--                            if (selectedProjectId === "" || taskProjectId === selectedProjectId) {-->
                        <!--                            taskOption.style.display = ''; // Show task-->
                        <!--                            } else {-->
                        <!--                            taskOption.style.display = 'none'; // Hide task-->
                        <!--                            }-->
                        <!--                            }-->

                        <!--                            // Reset the task selection-->
                        <!--                            taskSelect.value = '';-->
                        <!--                            });-->
                        <!--                        </script>-->

                        <div class="description-group" style="width: 100%;">
                            <label>Description:</label>
                            <textarea name="description"></textarea>
                        </div>


                        <div class="submit-button">
                            <button type="submit">Submit</button>
                        </div>
                    </div>
                </form>

            </div>
        </t>
    </template>
    <template id="thank_you_page" name="Timesheet Thank You Page">
        <t t-call="website.layout">
            <div class="container">
                <div class="row justify-content-center mt-5">
                    <div class="col-8 text-center">
                        <h1>Thank You!</h1>
                        <p>Your timesheet has been submitted successfully.</p>
                        <a href="/my/timesheets" class="btn btn-primary mt-3">View Timesheet</a>
                        <div>
                            <a href="/employee/timesheet_form" class="btn btn-secondary mt-3">Add Another Timesheet</a>

                        </div>
                    </div>
                </div>
            </div>
        </t>

    </template>
    <template id="error_timesheet" name="Timesheet Thank You Page">
        <t t-call="website.layout">
            <div class="container">
                <div class="row justify-content-center mt-5">
                    <div class="col-8 text-center">

                    </div>
                </div>
            </div>
        </t>
    </template>
    <template id="error_timesheet" name="error">
        <t t-call="website.layout">
            <div class="container">
                <div class="row justify-content-center mt-5">
                    <div class="col-8 text-center">

                    </div>
                </div>
            </div>
        </t>
    </template>

</odoo>
