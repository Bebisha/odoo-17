<?xml version="1.0" encoding="UTF-8"?>
<odoo>
    <record model="ir.ui.view" id="kg_project_task_gantt_view_inherit">
        <field name="name">kg.project.task.gantt.inherit</field>
        <field name="model">project.task</field>
        <field name="inherit_id" ref="project_enterprise.project_task_view_gantt"/>
        <field name="arch" type="xml">
            <xpath expr="//gantt" position="replace">
                <gantt string="Tasks"
                       date_start="planned_date_begin"
                       date_stop="date_deadline"
                       decoration-danger="planning_overlap"
                       form_view_id="%(project_enterprise.project_task_view_form_in_gantt)d"
                       default_scale="week"
                       color="project_id"
                       display_unavailability="1"
                       precision="{'day': 'hour:quarter', 'week': 'day:half', 'month': 'day:half'}"
                       progress_bar="user_ids"
                       pill_label="True"
                       dependency_field="depend_on_ids"
                       dependency_inverted_field="dependent_ids"
                       default_group_by="project_id,name"
                       display_subtasks="1">
                    <field name="planning_overlap"/>
                    <field name="reason"/>
                    <templates>
                        <div t-name="gantt-popover">
                            <div name="project_id">
                                <strong>Project —</strong>
                                <t t-if="project_id" t-esc="project_id[1]"/>
                                <t t-else="">
                                    <span class="fst-italic text-muted">
                                        <i class="fa fa-lock"/>
                                        Private
                                    </span>
                                </t>
                            </div>
                            <div t-if="allow_milestones and milestone_id" groups="project.group_project_milestone">
                                <strong>Milestone —</strong>
                                <t t-esc="milestone_id[1]"/>
                            </div>
                            <!--                            <div t-if="user_names">-->
                            <div t-if="user_names">
                                <strong>Assignees —</strong>
                                <t t-esc="user_names"/>
                            </div>
                            <div t-if="partner_id">
                                <strong>Customer —</strong>
                                <t t-esc="partner_id[1]"/>
                            </div>
                            <div t-if="project_id">
                                <!-- Convert the planned_date_begin and date_deadline to JavaScript Date object -->
                                <t t-set="start_date" t-value="new Date(planned_date_begin)"/>
                                <t t-set="end_date" t-value="new Date(date_deadline)"/>

                                <!-- Format the start and end date to 'dd-mm-yy HH:mm:ss' format without weekday -->
                                <t t-esc="start_date.toLocaleString('en-GB', { day: '2-digit', month: '2-digit', year: '2-digit', hour: '2-digit', minute: '2-digit', second: '2-digit' })"/>
                                <i class="fa fa-long-arrow-right" title="Arrow"/>
                                <t t-esc="end_date.toLocaleString('en-GB', { day: '2-digit', month: '2-digit', year: '2-digit', hour: '2-digit', minute: '2-digit', second: '2-digit' })"/>
                            </div>
                            <div class="text-danger mt-2" t-if="planning_overlap">
                                <t t-out="planningOverlapHtml"/>
                            </div>
                            <div t-if="reason">
                                <strong>Reason —</strong>
                                <span class="text-muted" t-esc="reason"/>
                            </div>
                            <div t-else="" class="fst-italic text-muted">
                                <strong>Reason —</strong>
                                Not set
                            </div>
                        </div>
                    </templates>

                </gantt>
            </xpath>
        </field>
    </record>

    <odoo>
        <record id="view_task_form_inherit_reason" model="ir.ui.view">
            <field name="name">project.task.form.inherit.reason</field>
            <field name="model">project.task</field>
            <field name="inherit_id" ref="project.view_task_form2"/>
            <field name="arch" type="xml">
                <xpath expr="//sheet/notebook" position="inside">
                    <page string="Notes">
                        <field name="reason" placeholder="Enter the reason for changing the planned date..."/>
                        <field name="task_status" placeholder="Enter other remarks..."/>
                    </page>
                </xpath>
                <xpath expr="//notebook/page[@name='sub_tasks_page']" position="replace">
                    <page name="sub_tasks_page" string="Sub-tasks" invisible="not project_id">
                            <field name="child_ids" context="{'default_project_id': project_id, 'default_display_in_project': False, 'default_user_ids': user_ids, 'default_parent_id': id,                                     'default_partner_id': partner_id, 'default_milestone_id': allow_milestones and milestone_id}" widget="subtasks_one2many">
                                <tree editable="bottom" decoration-muted="state in ['1_done','1_canceled']" open_form_view="True">
                                    <field name="allow_milestones" column_invisible="True"/>
                                    <field name="display_in_project" column_invisible="True" force_save="1"/>
                                    <field name="sequence" widget="handle"/>
                                    <field name="id" optional="hide"/>
                                    <field name="parent_id" column_invisible="True"/>
                                    <field name="priority" widget="priority" nolabel="1" options="{'autosave': False}" width="40px"/>
                                    <field name="state" widget="project_task_state_selection" nolabel="1" options="{'autosave':  False}" width="40px"/>
                                    <field name="name" widget="name_with_subtask_count"/>
                                    <field name="subtask_count" column_invisible="True"/>
                                    <field name="closed_subtask_count" column_invisible="True"/>
                                    <field name="project_id" string="Project" optional="hide" options="{'no_open': 1}" widget="project"/>
                                    <field name="milestone_id" optional="hide" context="{'default_project_id': project_id}" column_invisible="not parent.allow_milestones" invisible="not allow_milestones"/>
                                    <field name="partner_id" optional="hide" widget="res_partner_many2one" invisible="not project_id"/>
<!--                                    <field name="user_ids" widget="many2many_avatar_user" optional="show"/>-->
                                    <field name="company_id" groups="base.group_multi_company" optional="hide"/>
                                    <field name="company_id" column_invisible="True"/>
                                    <field name="date_deadline" invisible="state in ['1_done', '1_canceled']" optional="hide" decoration-danger="date_deadline and date_deadline &lt; current_date"/>
                                    <field name="activity_ids" string="Next Activity" widget="list_activity" optional="hide"/>
                                     <field name="my_activity_date_deadline" string="My Deadline" widget="remaining_days" options="{'allow_order': '1'}" optional="hide"/>
                                    <field name="rating_last_text" string="Rating" decoration-danger="rating_last_text == 'ko'" decoration-warning="rating_last_text == 'ok'" decoration-success="rating_last_text == 'top'" class="fw-bold" widget="badge" optional="hide" invisible="rating_last_text == 'none'" column_invisible="True" groups="project.group_project_rating"/>
                                    <field name="tag_ids" widget="many2many_tags" options="{'color_field': 'color'}" optional="hide"/>
                                    <field name="stage_id" optional="hide" context="{'default_project_id': project_id}"/>
                                    <field name="progress" widget="progressbar"/>
                                    <field name="reason"/>
                                    <field name="task_status"/>
                                </tree>
                            </field>
                        </page>
                </xpath>
            </field>
        </record>
    </odoo>


    <record id="action_project_progress_chart" model="ir.actions.act_window">
        <field name="name">Project Gantt Chart</field>
        <field name="type">ir.actions.act_window</field>
        <field name="res_model">project.task</field>
        <field name="view_mode">gantt</field>
    </record>

    <menuitem id="menu_project_progress_chart" parent="project.menu_project_report"
              action="action_project_progress_chart"/>


</odoo>